<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">

    <title>HTML canvas video player</title>

    <link rel="stylesheet" href="skyblue.css">
    <link rel="stylesheet" href="demo/demo.css">
    <link href="node_modules/video.js/dist/video-js.css" rel="stylesheet" />
<style>

</style>
</head>
<body>
<div class="cover" >
    <div class="paint-pad" id="paint-pad"></div>
    <div class="button-div" ><label class="label label-txt">Label Text:
        <input class="form-control label-txt" type="text" value="Demo Text"></label>
        <hr class="label-txt">
        <button class="btn btn-primary confirm-edit" >Confirm</button>
        <button class="btn btn-light cancel-edit" >Cancel</button></div>
</div>
<div class="header">
    <div class="content">
        <a href="https://github.com/wangchengyu/video_in_canvas" class="padding-right-20">GitHub</a>
        <a href="https://github.com/wangchengyu/video_in_canvas/archive/master.zip">Download</a>
    </div>
</div>
<div class="content">
    <video  id="video-1" class="video-js"
            controls
            preload="auto"
            width="800"
            height="450"
            data-setup="{}" muted>
        <source src="./w.mp4" type=video/mp4>
        <!-- <source src=http://techslides.com/demos/sample-videos/small.ogv type=video/ogg>
        <source src=http://techslides.com/demos/sample-videos/small.mp4 type=video/mp4>
        <source src=http://techslides.com/demos/sample-videos/small.3gp type=video/3gp> -->
    </video>


</div><!--div id="canvas-container" class="graph">123</div-->
<hr>
<div class="content" style="margin-bottom: 5px; padding-bottom: 0;">
    <div class="keyframebar" id="keyframebar" style="width: 100%;height:130px">
    </div>
</div>
<div class="content elementbars" id="elementbars">
</div>
<div class="content">
    <div class="row">
        <button class="btn btn-primary dropbtn" style="font-size: 30px; min-width: 30px; margin-right: 20px;" onclick="myFunction()">
            +
        </button>
        <div id="myDropdown" class="dropdown-content">
            <a href="#" id="el-rect" class="el-menu" data-type="rect">Rect ☐</a>
            <a href="#" id="el-arrows" class="el-menu" data-type="arrow">Arrow ⇨</a>
            <a href="#" id="el-text" class="el-menu" data-type="label">Text</a>
        </div>
    </div>

</div>

<div class="content">
    <p class="margin-top-50">
        Released under MIT licence.
    </p>
</div>



<script src="js/jquery.min.js" ></script>
<script src="js/canvas-video-player.js"></script>
<script src="js/jmgraph.js"></script>
<script src="node_modules/video.js/dist/video.js"></script>
<script src="js/keyframe.js"> </script>
<script src="js/el-edit-event.js"></script>
<!--script src="node_modules/videojs-overlay/dist/videojs-overlay.js"></script-->

<script >

    const player = videojs('video-1', {controls: true});
    const video = $("#video-1 video").get(0);

    const g1 = jmGraph.create('keyframebar', {
        width: $("#keyframebar").width(),
        height: $("#keyframebar").height(),
    });

    const kf_canvas = g1.canvas;

    let c = null;
    let jm_player = null;

    const initPlayer = () => {
        $(player.el_.children[0]).addClass('vjs-hidden');
        var container = $(".vjs-text-track-display").get(0);
        container.id = "vjs-text-track-display";
        container.style.bottom = 0;
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        jm_player = jmGraph.create('vjs-text-track-display', {
            width: $("#vjs-text-track-display").width(),
            height: $("#vjs-text-track-display").height(),
        });

        c = jm_player.canvas.getContext("2d");
        jm_player.redraw();


        // jm_player.style = {
        //     fillStyle : () => {
        //         c.drawImage(video, 0, 0, jm_player.canvas.width, jm_player.canvas.height);
        //     }
        // }

        setOffset100ms(video.duration);

        video.addEventListener("timeupdate", () => {
            jm_player.needUpdate = true;
        });

    }


    $(function() {


        const kf = new KeyFrame(kf_canvas, video);
        const el_list = [];

        const paint = jmGraph.create('paint-pad', {
            width: 800,
            height: 450,
        });

        let el_id_index = 0;

        const add_new_element = (type) => {
            let id = el_id_index++;
            let el_object = buildShapeObject(type);
            let el_id_name = "el_" + id;
            let el_html = $("<div class='elementbar' id='" + el_id_name + "' data-index='" + id + "'>" +
                "<input type='checkbox' class='el_checkbox' alt='Visible or not' checked />" +
                "<span class='icon-trash el-trash' title='delete'></span>" +
                "<span class='icon-edit el-edit' title='edit'></span>" +
                "</div>");
                
            $(".elementbars").append(el_html);

            let start = video.currentTime;
            let end = video.currentTime + 2 > video.duration ? video.duration: video.currentTime + 2;
            let left = start / video.duration * (VIDEO_WIDTH - 2);
            let right = end / video.duration * (VIDEO_WIDTH -2);

            var el_jm = jmGraph.create(el_id_name, {
                width: $("#" + el_id_name).width(),  // this is the size of video
                height: $("#" + el_id_name).height(),
            });

            let el = {
                index: id,                          //unique id
                type: type,                         //type: rect arrow
                object: el_object,                  //shape obj
                start_time: start,                  //start
                end_time: end,                      //end
                left: left,
                right: right,
                dom: el_html.get(0),
                jm: el_jm,
                updated: true,                      //TODO: no modi, no update
                check_visible: true
            };

            el_object.el = el;
            el_jm.canvas.el = el;

            el_jm.canvas.addEventListener("mousemove", el_mousemove);
            el_jm.canvas.addEventListener("mouseup", el_mouseup);
            el_jm.canvas.addEventListener("mousedown", el_mousedown);

            jm_player.children.add(el_object);

            el_list.push(el);

            // visible
            $("#" + el_id_name + " input").change((e) => {
                el.check_visible = $("#" + el_id_name + " input").prop("checked");
            });

            // deleted
            $("#" + el_id_name + " .el-trash").click((e) => {
                // invisible
                el.object.remove();
                el.dom.parentNode.removeChild(el.dom);

                el.object = null;
                el.jm = null;
                el.dom = null;

                for (var i = 0; i < el_list.length; i++) {
                    if (el_list[i].index === el.index) {
                        el_list.splice(i, 1);
                        break;
                    }
                }

            });

            // editable
            $("#" + el_id_name + " .el-edit").click((e) => {
                video.pause();

                // give el properties to rect
                updateEditMode(el);

                let body = document.getElementsByTagName("body")[0];
                $(".cover")
                    .css("height", body.clientHeight)
                    .show();

                if (el.type === "label") {
                    $(".label-txt").show();
                    $("input.label-txt").val(el.object.text);

                } else
                    $(".label-txt").hide();
            });
        };

        const update_element = (u_el) => {
            let el_object = u_el.object;

            if (u_el.type === 'rect') {
                el_object.position.x = resizeRect.position.x;
                el_object.position.y = resizeRect.position.y;
                el_object.width = resizeRect.width;
                el_object.height = resizeRect.height;
            }

            if (u_el.type === 'arrow') {
                el_object.start.x = arrow.start.x;
                el_object.start.y = arrow.start.y;
                el_object.end.x = arrow.end.x;
                el_object.end.y = arrow.end.y;
            }

            if (u_el.type === "label") {
                el_object.text = label.text;
                el_object.center = Object.assign({}, label.center);
                el_object.style = Object.assign({}, label.style);

            }
        }

        const exit_edit_mode = (state, type,  u_el) => {
            $(".cover").hide();

            if (state === "add")
                add_new_element(type);

            if (state === "update") {
                update_element(u_el);
            }
        }

        $(".confirm-edit").click(jm_confirm);
        $(".cancel-edit").click(jm_cancel);
        $("input.label-txt").keyup(jm_label_change);

        setJmObject(paint, video, exit_edit_mode);

        $(".el-menu").click((event)=>{
            // go to edit mode
            let body = document.getElementsByTagName("body")[0];
            $(".cover")
                .css("height", body.clientHeight)
                .show();

            let type = $(event.target).data("type");

            if (type === "label") {
                $(".label-txt").show();
                $("input.label-txt").val("Demo Text");
            } else
                $(".label-txt").hide();

            initEditMode(type);
        });

        // animation loop
        const raf_update = function() {

            if (c && jm_player.needUpdate)
               c.drawImage(video, 0,0, c.canvas.width, c.canvas.height);

            if (jm_player && jm_player.children && jm_player.children.length) {
                jm_player.children.each((i, item) => {
                    item.visible = item.el.check_visible && (video.currentTime >= item.el.start_time && video.currentTime <= item.el.end_time);
                    if (item.visible)
                        item.paint();
                })
            }

            if (!video.paused)
                kf.updated = true;

            if (kf.updated) {
                kf.refreshBackground();
                kf.fillAllTimeLabel();
                kf.fillAllPreviewImages();
                kf.drawTimeLine();
                kf.drawFloatLine();
                kf.setFloatPreviewPosition();

                kf.updated = false;
            }

            if (el_list.length > 0) {
                for (var i = 0; i < el_list.length; i++) {
                    let el = el_list[i];

                    if (!el.updated)
                        continue;

                    let canvas = el.jm.canvas;
                    let el_ctx = canvas.getContext('2d');

                    el_ctx.beginPath();
                    el_ctx.fillStyle = "#000";
                    el_ctx.fillRect(0, 0, VIDEO_WIDTH, 20);
                    el_ctx.fillStyle = "#FFF";
                    el_ctx.fillRect(1, 1, VIDEO_WIDTH - 2 , 20 - 2);

                    el_ctx.fillStyle = "#8F8";

                    el_ctx.fillRect(el.left + 1, 1, (el.right - el.left), 20 - 2);
                    el_ctx.stroke();

                    kf.drawFloatLine(el_ctx, true);
                }
            }


            requestAnimationFrame(raf_update);
        };

        raf_update();

    });

    /* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
    function myFunction() {
        document.getElementById("myDropdown").style.display = "inline";
    }

    // Close the dropdown menu if the user clicks outside of it
    window.onclick = function(event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                openDropdown.style.display = "none";
            }
        }
    }
</script>
</body>
</html>
