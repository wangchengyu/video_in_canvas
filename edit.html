<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">

    <title>HTML canvas video player</title>

    <link rel="stylesheet" href="skyblue.css">
    <link rel="stylesheet" href="demo/demo.css">
</head>
<body>
<div class="header">
    <div class="content">
        <a href="https://github.com/wangchengyu/video_in_canvas" class="padding-right-20">GitHub</a>
        <a href="https://github.com/wangchengyu/video_in_canvas/archive/master.zip">Download</a>
    </div>
</div>
<div class="video-wrapper js-video-wrapper">
    <div class="video-responsive" id="player">
        <video class="video js-video" id="video-1" width="960" height="540" muted>
            <source src="./LiSA.mp4" type=video/mp4>
            <!-- <source src=http://techslides.com/demos/sample-videos/small.ogv type=video/ogg>
            <source src=http://techslides.com/demos/sample-videos/small.mp4 type=video/mp4>
            <source src=http://techslides.com/demos/sample-videos/small.3gp type=video/3gp> -->
        </video>

        <canvas class="canvas js-canvas"></canvas>
    </div>
</div>



<div class="content">
    <div class="row">
        <div class="col md-8">
            <div class="video-wrapper">
                <div id="video-container"></div>
                <div class="video-timeline js-timeline">
                    <div class="video-timeline-passed js-timeline-passed">
                    </div>
                </div>
            </div>
        </div>
        <div class="col md-4">
            <div class="row">
                <div class="col md-12">
                    <a class="btn btn-success" onclick="video.play()">Play</a>
                </div>
                <div class="col md-12">
                    <a class="btn btn-danger" onclick="video.pause()">Pause</a>
                </div>
                <div class="col md-12">
                    <label>Video Current Time</label><input type="number" class="js-current" placeholder="currentTime" step="0.001"/>
                </div>
                <div class="col md-12">
                    <label>Mouse Position</label>
                    <span >top:
                        <input type="number" class="js-mouse_top" ></span><br>
                    <span >left:
                        <input type="number" class="js-mouse_left" ></span>

                </div>
            </div>
        </div>
    </div>

    <div class="row">

    </div>
    <hr>
    <div class="row">
        <div class="col md-2">
            <label><input type="radio" name="element_type" class="js-rect" checked>rect</label>
        </div>
        <div class="col md-2">
            <label><input type="radio" name="element_type" class="js-arrawline" >arrawline</label>
        </div>
        <div class="col md-2">
            <label><input type="radio" name="element_type" class="js-label" >label</label>
        </div>
    </div>

    <div class="row js-rect-editor" style="display:none;">
        <div class="col md-2">
            top: <input type="text" placeholder="top" value="100"/>
        </div>
        <div class="col md-2">
            left: <input type="text"  placeholder="left" value="100"/>
        </div>
        <div class="col md-2">
            width:<input type="text" placeholder="width" value="100"/>
        </div>
        <div class="col md-2">
            height: <input type="text" placeholder="height" value="100"/>
        </div>
        <div class="col md-2">
            duration: <input type="text" placeholder="duration" value="3"/>
        </div>
    </div>
    <div class="row js-arrawline-editor" style="display:none;">
        <div class="col md-2">
            start x: <input type="text" placeholder="startx" value="100"/>
        </div>
        <div class="col md-2">
            start y: <input type="text"  placeholder="starty" value="100"/>
        </div>
        <div class="col md-2">
            end x:<input type="text" placeholder="endx" value="100"/>
        </div>
        <div class="col md-2">
            end y: <input type="text" placeholder="endy" value="100"/>
        </div>
        <div class="col md-2">
            duration: <input type="text" placeholder="duration" value="3"/>
        </div>
    </div>
    <div class="row js-label-editor" style="display:none;">
        <div class="col md-2">
            top: <input type="text" placeholder="ltop" value="100"/>
        </div>
        <div class="col md-2">
            left: <input type="text"  placeholder="lleft" value="100"/>
        </div>
        <div class="col md-2">
            size:<input type="text" placeholder="size" value="24"/>
        </div>
        <div class="col md-2">
            text: <input type="text" placeholder="text" value="demo text"/>
        </div>
        <div class="col md-2">
            duration: <input type="text" placeholder="duration" value="3"/>
        </div>
    </div>

    <div class="row js-rect-editor js-arrawline-editor js-label-editor" style="padding-top: 10px; padding-bottom: 10px; display:none">
        <div class="col md-2">
            <a class="btn btn-danger" onclick="add_new_element()">add </a>
        </div>
        <div class="col md-2">
            <a class="btn btn-danger" onclick="cancel_temp_element()">cancel</a>
        </div>
    </div>
    <div class="row js-hint">
        Please <b>click</b> the progress bar to the appropriate time and <b>drag</b> as rectÔºÅ
    </div>
    <p class="margin-top-50">
        Released under MIT licence.
    </p>
</div>


<script src="js/jquery.min.js" ></script>
<script src="js/canvas-video-player.js"></script>
<script src="js/jmgraph.js"></script>

<script>
    var con = document.getElementById("video-container");

    // it will create a canvas under this div named "video-container"
    var div_width = con.clientWidth;
    var div_height = div_width * 540 / 960

    var g = jmGraph.create('video-container', {
        width: div_width,  // this is the size of video
        height: div_height,
    });

    var canvasVideo = new CanvasVideoPlayer({
    	videoSelector: '.js-video',
    	canvasSelector: g.canvas,
    	timelineSelector: '.video-timeline',
    	audio: true
    });

    // this is the context for canvas
    var canvas = g.canvas;
    var ctx = canvas.getContext('2d');
    // video dom
    var video = document.getElementById("video-1");

    var currentTime = $("input[placeholder=currentTime]");



    var action_rect = null;
    var action_arrawline = null;
    var action_label = null;
    var edit_state = false

    g.bind("mousedown", (event) => {
        if ($(".js-rect").prop("checked") && action_rect == null && !edit_state) {

            $(".js-rect-editor").show();
            $(".js-hint").hide();

            //console.log(event);
            action_rect = g.createShape("rect", {
                style: {stroke:"#ccc", lineType:"dotted", lineWidth: 3},
                position: {x: event.position.x, y: event.position.y},
                width: 0,
                height: 0,
            })

            action_rect.resizing = true;

            g.children.add(action_rect); //temp rect

            action_rect.start_time = video.currentTime - 0.001 //for show at this time point
            action_rect.end_time = video.currentTime + 3

            //update input
            $("input[placeholder=top]").val(action_rect.position.y);
            $("input[placeholder=left]").val(action_rect.position.x);

            edit_state = true;
        }

        if ($(".js-arrawline").prop("checked")) {

            $(".js-arrawline-editor").show();
            $(".js-hint").hide();

            //console.log(event);
            action_arrawline = g.createShape("arrawline", {
                style: {stroke:"#ccc", lineType:"dotted", lineWidth: 3, dashLength: 20},
                start: {x: event.position.x, y: event.position.y},
                end: {x: event.position.x, y: event.position.y}
            })

            action_arrawline.resizing = true;

            g.children.add(action_arrawline); //temp rect

            action_arrawline.start_time = video.currentTime - 0.001 //for show at this time point
            action_arrawline.end_time = video.currentTime + 3

            //update input
            $("input[placeholder=startx]").val(action_arrawline.start.x);
            $("input[placeholder=starty]").val(action_arrawline.start.y);

            edit_state = true;
        }

        if ($(".js-label").prop("checked") && action_label == null && !edit_state) {

            $(".js-label-editor").show();
            $(".js-hint").hide();

            //console.log(event);
            action_label = g.createShape("label", {
                style: {
                    stroke:"#ccc",
                    fill: "#ccc",
                    textAlign: 'left',
                    fontFamily: "Arial",
                    fontSize: 60,
                    border: {
                        left:1,
                        top:1,
                        right:1,
                        bottom:1,
                        style: {
                            stroke: 'red'
                        }
                    },
                },
                position: {x: event.position.x, y: event.position.y},
                text: "demo text",

            })

            action_label.resizing = true;

            g.children.add(action_label); //temp rect

            action_label.start_time = video.currentTime - 0.001 //for show at this time point
            action_label.end_time = video.currentTime + 3

            //update input
            $("input[placeholder=ltop]").val(action_label.position.y);
            $("input[placeholder=lleft]").val(action_label.position.x);

            edit_state = true;
        }

        return true;
    });

    g.bind("mousemove", (event) => {

        $(".js-mouse_top").val(event.position.y);
        $(".js-mouse_left").val(event.position.x);

        if ($(".js-rect").prop("checked") && action_rect !== null && edit_state) {

            if (event.event.buttons === 0)
                return ;

            if (!action_rect.resizing)
                return ;

            action_rect.width = event.position.x - action_rect.position.x;
            action_rect.height = event.position.y - action_rect.position.y;

            //update input
            $("input[placeholder=width]").val(action_rect.width);
            $("input[placeholder=height]").val(action_rect.height);

            return ;
        }

        if ($(".js-arrawline").prop("checked") && action_arrawline !== null && edit_state) {

            if (event.event.buttons === 0)
                return ;

            if (!action_arrawline.resizing)
                return ;

            action_arrawline.end.x = event.position.x;
            action_arrawline.end.y = event.position.y;

            //update input
            $("input[placeholder=endx]").val(action_arrawline.end.x);
            $("input[placeholder=endy]").val(action_arrawline.end.y);

            return true;
        }

        if ($(".js-label").prop("checked") && action_label !== null && edit_state) {

            if (event.event.buttons === 0)
                return ;

            if (!action_label.resizing)
                return ;

            action_label.width = event.position.x - action_label.position.x;
            action_label.height = event.position.y - action_label.position.y;
            action_label.style.fontSize = action_label.height -4; // TODO: has a bug

            //update input
            $("input[placeholder=size]").val(action_label.style.fontSize);


            return true;
        }

    });

    g.bind("mouseup", (event) => {
        //debugger;
        if ($(".js-rect").prop("checked") && action_rect !== null && edit_state) {

            if (action_rect.width < 2 && action_rect.height < 2) {
                exit_edit_state("rect");
            }
            action_rect.style.stroke = "#F00";
            action_rect.canMove(true);
            action_rect.bind("moveend", function() {
                $("input[placeholder=top]").val(action_rect.position.y);
                $("input[placeholder=left]").val(action_rect.position.x);
            });
            action_rect.resizing = false;

            return true;
        }

        if ($(".js-arrawline").prop("checked") && action_arrawline !== null && edit_state) {
            if (action_arrawline === null) {
                return ;
            }

            if (action_arrawline.width < 2 && action_arrawline.height < 2) {
                exit_edit_state("arrawline");
            }
            action_arrawline.style.stroke = "#F00";
            action_arrawline.canMove(true);
            action_arrawline.bind("moveend", function() {
                $("input[placeholder=starty]").val(action_arrawline.start.y);
                $("input[placeholder=startx]").val(action_arrawline.start.x);
                $("input[placeholder=endy]").val(action_arrawline.end.y);
                $("input[placeholder=endx]").val(action_arrawline.end.x);
            });

            action_arrawline.resizing = false;

            return true;
        }

        if ($(".js-label").prop("checked") && action_label !== null && edit_state) {

            if (action_label.width < 2 && action_label.height < 2) {
                exit_edit_state("label");
            }
            // action_label.style.stroke = "#F00";
            action_label.canMove(true);
            action_label.bind("moveend", function() {
                $("input[placeholder=ltop]").val(action_label.position.y);
                $("input[placeholder=lleft]").val(action_label.position.x);
            });
            action_label.resizing = false;

            return true;
        }
    });


    window.update = function() {

        if (g.children) {
            g.children.each((i, item) => {
                item.visible = video.currentTime > item.start_time && video.currentTime < item.end_time;
            })
        }

        if (video.paused) {
            if (g.needUpdate) {
                g.redraw();
            }
        } else {
            currentTime.val(video.currentTime.toFixed(2));

            if (ctx) {
                ctx.drawImage(video, 0,0, canvas.width, canvas.height);

                if (g.children) {
                    g.children.each((i, item) => {
                        if (item.visible)
                            item.paint();
                    })
                }
            }
        }



        requestAnimationFrame(update);
    }

    update();

    const add_new_element = function() {
        if ($(".js-rect").prop("checked") && action_rect !== null && edit_state) {

            let top = Number.parseFloat($("input[placeholder=top]").val());
            let left = Number.parseFloat($("input[placeholder=left]").val());
            let width = Number.parseFloat($("input[placeholder=width]").val());
            let height = Number.parseFloat($("input[placeholder=height]").val());
            let start_time = video.currentTime - 0.01; //Number.parseFloat($("input[placeholder=start_time]").val());
            let end_time = video.currentTime + Number.parseFloat($("input[placeholder=duration]").val());

            action_rect.style.stroke = "#F00";
            action_rect.style.lineType = "solid";
            action_rect.position.x = left;
            action_rect.position.y = top;
            action_rect.width = width;
            action_rect.height = height;
            action_rect.start_time = start_time;
            action_rect.end_time = end_time;

            action_rect = null;
            edit_state = false;

            $(".js-rect-editor").hide();
            $(".js-hint").show();
        }

        if ($(".js-arrawline").prop("checked") && action_arrawline !== null && edit_state) {

            let startx = Number.parseFloat($("input[placeholder=startx]").val());
            let starty = Number.parseFloat($("input[placeholder=starty]").val());
            let endx = Number.parseFloat($("input[placeholder=endx]").val());
            let endy = Number.parseFloat($("input[placeholder=endy]").val());
            let start_time = video.currentTime - 0.01; //Number.parseFloat($("input[placeholder=start_time]").val());
            let end_time = video.currentTime + Number.parseFloat($("input[placeholder=duration]").val());

            action_arrawline.style.stroke = "#F00";
            action_arrawline.style.lineType = "solid";
            action_arrawline.start.x = startx;
            action_arrawline.start.y = starty;
            action_arrawline.end.x = endx;
            action_arrawline.end.y = endy;
            action_arrawline.start_time = start_time;
            action_arrawline.end_time = end_time;

            action_arrawline = null;
            edit_state = false;

            $(".js-arrawline-editor").hide();
            $(".js-hint").show();
        }

        if ($(".js-label").prop("checked") && action_label !== null && edit_state) {

            let top = Number.parseFloat($("input[placeholder=ltop]").val());
            let left = Number.parseFloat($("input[placeholder=lleft]").val());
            let size = Number.parseFloat($("input[placeholder=size]").val());
            let text = $("input[placeholder=text]").val();
            let start_time = video.currentTime - 0.01; //Number.parseFloat($("input[placeholder=start_time]").val());
            let end_time = video.currentTime + Number.parseFloat($("input[placeholder=duration]").val());

            // action_label.style.stroke = "#F00";
            action_label.style.fill="#F00";
            action_label.style.lineType = "solid";
            action_label.position.x = left;
            action_label.position.y = top;
            action_label.text = text;
            action_label.style.border = {}

            action_label.start_time = start_time;
            action_label.end_time = end_time;

            action_label = null;
            edit_state = false;

            $(".js-label-editor").hide();
            $(".js-hint").show();
        }


    }

    const cancel_temp_element = function() {
        if ($(".js-rect").prop("checked")) {
            exit_edit_state("rect");
        }
        if ($(".js-arrowline").prop("checked")) {
            exit_edit_state("arrawline");
        }
        if ($(".js-label").prop("checked")) {
            exit_edit_state("label");
        }

    }

    const exit_edit_state = function(type) {
        if (type === "rect") {
            if (!action_rect)
                return;

            action_rect.canMove(false);
            g.children.remove(action_rect);
            action_rect = null;
            edit_state = false;

            $(".js-rect-editor").hide();
            $(".js-hint").show();
        }

        if (type === "arraw") {
            if (!action_arrawline)
                return;

            action_arrawline.canMove(false);
            g.children.remove(action_arrawline);
            action_arrawline = null;
            edit_state = false;

            $(".js-arrowline-editor").hide();
            $(".js-hint").show();
        }

        if (type === "label") {
            if (!action_label)
                return;

            action_label.canMove(false);
            g.children.remove(action_label);
            action_label = null;
            edit_state = false;

            $(".js-label-editor").hide();
            $(".js-hint").show();
        }
    }

    $(function() {
        $(".js-current").change(function() {
            video.currentTime = Number.parseFloat($(this).val());
            currentTime.value = video.currentTime.toFixed(2);
        });

        video.ontimeupdate = () => {
             if (video.paused)
                 g.redraw();
        }

        // set fill the video under element
        g.style = {fillStyle: function () {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }};

        video.currentTime = 0.01;

        setTimeout(function() {
            g.redraw();
        }, 500);
    });

</script>
</body>
</html>
