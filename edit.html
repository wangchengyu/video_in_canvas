<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">

    <title>HTML canvas video player</title>

    <link rel="stylesheet" href="skyblue.css">
    <link rel="stylesheet" href="demo/demo.css">
    <link href="node_modules/video.js/dist/video-js.css" rel="stylesheet" />
<style>

</style>
</head>
<body>
<div class="cover" >
    <div class="paint-pad" id="paint-pad"></div>
    <div class="button-div" >
        <button class="btn btn-primary confirm-edit" >Confirm</button>
        <button class="btn btn-light cancel-edit" >Cancel</button></div>

</div>
<div class="header">
    <div class="content">
        <a href="https://github.com/wangchengyu/video_in_canvas" class="padding-right-20">GitHub</a>
        <a href="https://github.com/wangchengyu/video_in_canvas/archive/master.zip">Download</a>
    </div>
</div>
<div class="content">
    <video  id="video-1" class="video-js"
            controls
            preload="auto"
            width="800"
            height="450"
            data-setup="{}" muted>
        <source src="./w.mp4" type=video/mp4>
        <!-- <source src=http://techslides.com/demos/sample-videos/small.ogv type=video/ogg>
        <source src=http://techslides.com/demos/sample-videos/small.mp4 type=video/mp4>
        <source src=http://techslides.com/demos/sample-videos/small.3gp type=video/3gp> -->
    </video>


</div><!--div id="canvas-container" class="graph">123</div-->
<hr>
<div class="content" style="margin-bottom: 5px; padding-bottom: 0;">
    <div class="keyframebar" id="keyframebar" style="width: 100%;height:130px">
    </div>
</div>
<div class="content elementbars" id="elementbars">
</div>
<div class="content">
    <div class="row">
        <button class="btn btn-primary dropbtn" style="font-size: 30px; min-width: 30px; margin-right: 20px;" onclick="myFunction()">
            +
        </button>
        <div id="myDropdown" class="dropdown-content">
            <a href="#" id="el-rect" class="el-menu">Rect ☐</a>
            <a href="#" id="el-arrows" class="el-menu">Arrows ⇨</a>
            <a href="#" id="el-text" class="el-menu">Text</a>
        </div>
    </div>

</div>

<div class="content">
    <p class="margin-top-50">
        Released under MIT licence.
    </p>
</div>



<script src="js/jquery.min.js" ></script>
<script src="js/canvas-video-player.js"></script>
<script src="js/jmgraph.js"></script>
<script src="node_modules/video.js/dist/video.js"></script>
<script src="js/keyframe.js"> </script>
<script src="js/el-edit-event.js"></script>
<!--script src="node_modules/videojs-overlay/dist/videojs-overlay.js"></script-->

<script >

    const player = videojs('video-1');
    const video = $("#video-1 video").get(0);

    const g1 = jmGraph.create('keyframebar', {
        width: $("#keyframebar").width(),
        height: $("#keyframebar").height(),
    });

    const kf_canvas = g1.canvas;


    let c = null;
    let player1 = null;

    const initPlayer = () => {
        $(player.el_.children[0]).addClass('vjs-hidden');
        $(".vjs-text-track-display").get(0).id = "vjs-text-track-display";

        player1 = jmGraph.create('vjs-text-track-display', {
            width: $("#vjs-text-track-display").width(),
            height: $("#vjs-text-track-display").height(),
        });

        c = player.canvas.getContext("2d");

    }

    $(function() {

        const kf = new KeyFrame(kf_canvas, video);
        const el_list = [];

        const paint = jmGraph.create('paint-pad', {
            width: 800,
            height: 450,
        });

        const add_new_element = () => {
            let rect = buildRectObject();
            let el_id = "el_" + el_list.length;
            let el_html = $("<div class='elementbar' id='" + el_id + "' data-index='"+el_list.length+"'>" +
                "<input type='checkbox' class='el_checkbox' alt='Visible or not' checked />" +
                "<span class='icon-trash el-trash' title='delete'></span>" +
                "<span class='icon-edit el-edit' title='edit'></span>" +
                "</div>");
            $(".elementbars").append(el_html);

            var el_jm = jmGraph.create(el_id, {
                width: $("#" + el_id).width(),  // this is the size of video
                height: $("#" + el_id).height(),
            });

            el_list.push({
                type: "rect",                       //type
                object: rect,                       //shape obj
                start_time: video.currentTime,      //start
                end_time: video.currentTime + 3,    //end
                left: video.currentTime / video.duration * (VIDEO_WIDTH - 2),
                right: (video.currentTime + 3) / video.duration * (VIDEO_WIDTH -2),
                dom: el_html,
                jm: el_jm,
                updated: true //TODO: no modi, no update
            });

            //player1.children.add(rect);

            el_jm.canvas.el = el_list[el_list.length - 1];

            el_jm.canvas.addEventListener("mousemove", el_mousemove);
            el_jm.canvas.addEventListener("mouseup", el_mouseup);
            el_jm.canvas.addEventListener("mousedown", el_mousedown);

        };


        const exit_edit_mode = (state) => {
            $(".cover").hide();

            if (state)
                add_new_element();
        }

        $(".confirm-edit").click(jm_confirm);
        $(".cancel-edit").click(jm_cancel);

        setJmObject(paint, video, exit_edit_mode);

        $(".el-menu").click((event)=>{
            // go to edit mode
            let body = document.getElementsByTagName("body")[0];
            $(".cover")
                .css("height", body.clientHeight)
                .show();

            initEditMode("rect");
        });


        // animation loop
        const raf_update = function() {

            if (c)
                c.drawImage(video, 0,0, VIDEO_WIDTH, VIDEO_HEIGHT);

            if (!video.paused)
                kf.updated = true;

            if (kf.updated) {
                kf.refreshBackground();
                kf.fillAllTimeLabel();
                kf.fillAllPreviewImages();
                kf.drawTimeLine();
                kf.drawFloatLine();
                kf.setFloatPreviewPosition();

                kf.updated = false;
            }

            if (el_list.length > 0) {
                for (var i = 0; i < el_list.length; i++) {
                    let el = el_list[i];

                    if (!el.updated)
                        continue;

                    let canvas = el.jm.canvas;
                    let el_ctx = canvas.getContext('2d');

                    el_ctx.beginPath();
                    el_ctx.fillStyle = "#000";
                    el_ctx.fillRect(0, 0, VIDEO_WIDTH, 20);
                    el_ctx.fillStyle = "#FFF";
                    el_ctx.fillRect(1, 1, VIDEO_WIDTH - 2 , 20 - 2);

                    el_ctx.fillStyle = "#8F8";

                    el_ctx.fillRect(el.left + 1, 1, (el.right - el.left), 20 - 2);
                    el_ctx.stroke();

                    kf.drawFloatLine(el_ctx, true);
                }
            }


            requestAnimationFrame(raf_update);
        };

        raf_update();

    });

    /* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
    function myFunction() {
        document.getElementById("myDropdown").style.display = "inline";
    }

    // Close the dropdown menu if the user clicks outside of it
    window.onclick = function(event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                openDropdown.style.display = "none";
            }
        }
    }
</script>
</body>
</html>
