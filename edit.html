<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">

    <title>HTML canvas video player</title>

    <link rel="stylesheet" href="skyblue.css">
    <link rel="stylesheet" href="demo/demo.css">
    <link href="node_modules/video.js/dist/video-js.css" rel="stylesheet" />
<style>

</style>
</head>
<body>
<div class="cover" >
    <div class="paint-pad" id="paint-pad"></div>
    <div class="button-div" >
        <button class="btn btn-primary confirm-edit" >Confirm</button>
        <button class="btn btn-light cancel-edit" >Cancel</button></div>

</div>
<div class="header">
    <div class="content">
        <a href="https://github.com/wangchengyu/video_in_canvas" class="padding-right-20">GitHub</a>
        <a href="https://github.com/wangchengyu/video_in_canvas/archive/master.zip">Download</a>
    </div>
</div>
<div class="content">
    <video  id="video-1" class="video-js"
            controls
            preload="auto"
            width="800"
            height="450"
            data-setup="{}" muted>
        <source src="./w.mp4" type=video/mp4>
        <!-- <source src=http://techslides.com/demos/sample-videos/small.ogv type=video/ogg>
        <source src=http://techslides.com/demos/sample-videos/small.mp4 type=video/mp4>
        <source src=http://techslides.com/demos/sample-videos/small.3gp type=video/3gp> -->
    </video>


</div><!--div id="canvas-container" class="graph">123</div-->
<hr>
<div class="content" style="margin-bottom: 5px; padding-bottom: 0px;">
    <div class="keyframebar" id="keyframebar" style="width: 100%;height:130px">
    </div>
</div>
<div class="content elementbars" id="elementbars">
</div>
<div class="content">
    <div class="row">
        <button class="btn btn-primary dropbtn" style="font-size: 30px; min-width: 30px; margin-right: 20px;" onclick="myFunction()">
            +
        </button>
        <div id="myDropdown" class="dropdown-content">
            <a href="#" id="el-rect" class="el-menu">Rect ☐</a>
            <a href="#" id="el-arrows" class="el-menu">Arrows ⇨</a>
            <a href="#" id="el-text" class="el-menu">Text</a>
        </div>
    </div>

</div>
</div>
<div class="content">
    <p class="margin-top-50">
        Released under MIT licence.
    </p>
</div>



<script src="js/jquery.min.js" ></script>
<script src="js/canvas-video-player.js"></script>
<script src="js/jmgraph.js"></script>
<script src="node_modules/video.js/dist/video.js"></script>
<script src="js/keyframe.js"> </script>
<script src="js/el-edit-event.js"></script>
<!--script src="node_modules/videojs-overlay/dist/videojs-overlay.js"></script-->

<script >

    const player = videojs('video-1');
    const video = $("#video-1 video").get(0);

    const g1 = jmGraph.create('keyframebar', {
        width: $("#keyframebar").width(),
        height: $("#keyframebar").height(),
    });

    const kf_canvas = g1.canvas;

    /*

    const add_new_element = function() {
        if ($(".js-rect").prop("checked") && action_rect !== null && edit_state) {

            let top = Number.parseFloat($("input[placeholder=top]").val());
            let left = Number.parseFloat($("input[placeholder=left]").val());
            let width = Number.parseFloat($("input[placeholder=width]").val());
            let height = Number.parseFloat($("input[placeholder=height]").val());
            let start_time = video.currentTime - 0.01; //Number.parseFloat($("input[placeholder=start_time]").val());
            let end_time = video.currentTime + Number.parseFloat($("input[placeholder=duration]").val());

            action_rect.style.stroke = "#F00";
            action_rect.style.lineType = "solid";
            action_rect.position.x = left;
            action_rect.position.y = top;
            action_rect.width = width;
            action_rect.height = height;
            action_rect.start_time = start_time;
            action_rect.end_time = end_time;

            action_rect = null;
            edit_state = false;

            $(".js-rect-editor").hide();
            $(".js-hint").show();
        }

        if ($(".js-arrawline").prop("checked") && action_arrawline !== null && edit_state) {

            let startx = Number.parseFloat($("input[placeholder=startx]").val());
            let starty = Number.parseFloat($("input[placeholder=starty]").val());
            let endx = Number.parseFloat($("input[placeholder=endx]").val());
            let endy = Number.parseFloat($("input[placeholder=endy]").val());
            let start_time = video.currentTime - 0.01; //Number.parseFloat($("input[placeholder=start_time]").val());
            let end_time = video.currentTime + Number.parseFloat($("input[placeholder=duration]").val());

            action_arrawline.style.stroke = "#F00";
            action_arrawline.style.lineType = "solid";
            action_arrawline.start.x = startx;
            action_arrawline.start.y = starty;
            action_arrawline.end.x = endx;
            action_arrawline.end.y = endy;
            action_arrawline.start_time = start_time;
            action_arrawline.end_time = end_time;

            action_arrawline = null;
            edit_state = false;

            $(".js-arrawline-editor").hide();
            $(".js-hint").show();
        }

        if ($(".js-label").prop("checked") && action_label !== null && edit_state) {

            let top = Number.parseFloat($("input[placeholder=ltop]").val());
            let left = Number.parseFloat($("input[placeholder=lleft]").val());
            let size = Number.parseFloat($("input[placeholder=size]").val());
            let text = $("input[placeholder=text]").val();
            let start_time = video.currentTime - 0.01; //Number.parseFloat($("input[placeholder=start_time]").val());
            let end_time = video.currentTime + Number.parseFloat($("input[placeholder=duration]").val());

            // action_label.style.stroke = "#F00";
            action_label.style.fill="#F00";
            action_label.style.lineType = "solid";
            action_label.position.x = left;
            action_label.position.y = top;
            action_label.text = text;
            action_label.style.border = {}

            action_label.start_time = start_time;
            action_label.end_time = end_time;

            action_label = null;
            edit_state = false;

            $(".js-label-editor").hide();
            $(".js-hint").show();
        }


    }

    const cancel_temp_element = function() {
        if ($(".js-rect").prop("checked")) {
            exit_edit_state("rect");
        }
        if ($(".js-arrowline").prop("checked")) {
            exit_edit_state("arrawline");
        }
        if ($(".js-label").prop("checked")) {
            exit_edit_state("label");
        }

    }

    const exit_edit_state = function(type) {
        if (type === "rect") {
            if (!action_rect)
                return;

            action_rect.canMove(false);
            g.children.remove(action_rect);
            action_rect = null;
            edit_state = false;

            $(".js-rect-editor").hide();
            $(".js-hint").show();
        }

        if (type === "arraw") {
            if (!action_arrawline)
                return;

            action_arrawline.canMove(false);
            g.children.remove(action_arrawline);
            action_arrawline = null;
            edit_state = false;

            $(".js-arrowline-editor").hide();
            $(".js-hint").show();
        }

        if (type === "label") {
            if (!action_label)
                return;

            action_label.canMove(false);
            g.children.remove(action_label);
            action_label = null;
            edit_state = false;

            $(".js-label-editor").hide();
            $(".js-hint").show();
        }
    }
    */

    $(function() {
        const kf = new KeyFrame(kf_canvas, video);
        const el_list = [];
        const paint = jmGraph.create('paint-pad', {
            width: 800,
            height: 450,
        });

        const add_new_element = () => {
            var rect = buildRectObject();
            var el_id = "el_" + el_list.length;
            var el_html = $("<div class='elementbar' id='" + el_id + "' data-index='"+el_list.length+"'></div>");
            $(".elementbars").append(el_html);

            var jm = jmGraph.create(el_id, {
                width: $("#" + el_id).width(),  // this is the size of video
                height: $("#" + el_id).height(),
            });

            el_list.push({
                type: "rect",                       //type
                object: rect,                       //shape obj
                start_time: video.currentTime,      //start
                end_time: video.currentTime + 3,    //end
                dom: el_html,
                jm: jm
            });



        };


        $(".el-menu").click((event)=>{
            const exit_edit_mode = (state) => {
                $(".cover").hide();

                if (state)
                    add_new_element();
            }
            // go to edit mode
            $(".cover").show();
            let ctx = paint.canvas.getContext("2d");
            ctx.drawImage(video, 0,0,800,450)
            let body = document.getElementsByTagName("body")[0];
            $(".cover").css("height", body.clientHeight);

            $(".confirm-edit").click(jm_confirm);
            $(".cancel-edit").click(jm_cancel);


            setJmObject(paint, exit_edit_mode);



        });


        // animation loop
        const raf_update = function() {
            if (!video.paused)
                kf.updated = true;

            if (kf.updated) {
                kf.refreshBackground();
                kf.fillAllTimeLabel();
                kf.fillAllPreviewImages();
                kf.drawTimeLine();
                kf.drawFloatLine();
                kf.setFloatPreviewPosition();

                kf.updated = false;
            }

            if (el_list.length > 0) {

                let el = el_list[0];
                let canvas = el.jm.canvas;
                let el_ctx = canvas.getContext('2d');

                el_ctx.fillStyle = "#000";
                el_ctx.fillRect(0, 0, VIDEO_WIDTH, 20 - 1);

                el_ctx.fillStyle = "#FFF";
                var leftpx = el.start_time / video.duration * VIDEO_WIDTH;
                var rightpx = el.end_time / video.duration * VIDEO_WIDTH;

                el_ctx.fillRect(leftpx, 0 + 1, rightpx, 20-2);
                //
                // el1_ctx.fillStyle = "#8F8";
                // el1_ctx.fillRect(160*2+1, 0+1, 160-2, 30-2);
            }


            requestAnimationFrame(raf_update);
        };

        raf_update();

    });

    /* When the user clicks on the button,
toggle between hiding and showing the dropdown content */
    function myFunction() {
        document.getElementById("myDropdown").style.display = "inline";
    }

    // Close the dropdown menu if the user clicks outside of it
    window.onclick = function(event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                openDropdown.style.display = "none";
            }
        }
    }
</script>
</body>
</html>
