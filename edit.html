<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">

    <title>HTML canvas video player</title>

    <link rel="stylesheet" href="skyblue.css">
    <link rel="stylesheet" href="demo/demo.css">
</head>
<body>
<div class="header">
    <div class="content">
        <a href="https://github.com/wangchengyu/video_in_canvas" class="padding-right-20">GitHub</a>
        <a href="https://github.com/wangchengyu/video_in_canvas/archive/master.zip">Download</a>
    </div>
</div>
<div class="video-wrapper js-video-wrapper">
    <div class="video-responsive" id="player">
        <video class="video js-video" id="video-1" width="960" height="540" muted>
            <source src="./w.mp4" type=video/mp4>
            <!-- <source src=http://techslides.com/demos/sample-videos/small.ogv type=video/ogg>
            <source src=http://techslides.com/demos/sample-videos/small.mp4 type=video/mp4>
            <source src=http://techslides.com/demos/sample-videos/small.3gp type=video/3gp> -->
        </video>

        <canvas class="canvas js-canvas"></canvas>
    </div>
</div>



<div class="content">
    <div class="row">
        <div class="col md-8">
            <div class="video-wrapper">
                <div id="video-container"></div>
                <div class="video-timeline js-timeline">
                    <div class="video-timeline-passed js-timeline-passed">
                    </div>
                </div>
            </div>
        </div>
        <div class="col md-4">
            <div class="row">
                <div class="col md-12">
                    <a class="btn btn-success" onclick="video.play()">Play</a>
                </div>
                <div class="col md-12">
                    <a class="btn btn-danger" onclick="video.pause()">Pause</a>
                </div>
                <div class="col md-12">
                    <label>Video Current Time</label><input type="number" class="js-current" placeholder="currentTime" step="0.001"/>
                </div>
                <div class="col md-12">
                    <label>Mouse Position</label>
                    <span >top:
                        <input type="number" class="js-mouse_top" ></span><br>
                    <span >left:
                        <input type="number" class="js-mouse_left" ></span>

                </div>
            </div>
        </div>
    </div>

    <div class="row">

    </div>
    <hr>
    <div class="row">
        <div class="col md-2">
            <label><input type="radio" name="element_type" class="js-rect" checked>rect</label>
        </div>
        <div class="col md-2">
            <label><input type="radio" name="element_type" disabled >arrawline</label>
        </div>
        <div class="col md-2">
            <label><input type="radio" name="element_type" disabled>text</label>
        </div>
    </div>

    <div class="row js-rect-editor" style="display:none;">
        <div class="col md-2">
            top: <input type="text" placeholder="top" value="100"/>
        </div>
        <div class="col md-2">
            left: <input type="text"  placeholder="left" value="100"/>
        </div>
        <div class="col md-2">
            width:<input type="text" placeholder="width" value="100"/>
        </div>
        <div class="col md-2">
            height: <input type="text" placeholder="height" value="100"/>
        </div>
        <div class="col md-2">
            duration: <input type="text" placeholder="duration" value="3"/>
        </div>
    </div>
    <div class="row js-rect-editor" style="padding-top: 10px; padding-bottom: 10px; display:none">
        <div class="col md-2">
            <a class="btn btn-danger" onclick="add_new_element()">add </a>
        </div>
        <div class="col md-2">
            <a class="btn btn-danger" onclick="cancel_temp_element()">cancel</a>
        </div>
    </div>
    <div class="row js-hint">
        Please <b>click</b> the progress bar to the appropriate time and <b>drag</b> as rectÔºÅ
    </div>
    <p class="margin-top-50">
        Released under MIT licence.
    </p>
</div>


<script src="js/jquery.min.js" ></script>
<script src="js/canvas-video-player.js"></script>
<script src="js/jmgraph.js"></script>

<script>
    var con = document.getElementById("video-container");

    // it will create a canvas under this div named "video-container"
    var div_width = con.clientWidth;
    var div_height = div_width * 540 / 960

    var g = jmGraph.create('video-container', {
        width: div_width,  // this is the size of video
        height: div_height,
    });

    var canvasVideo = new CanvasVideoPlayer({
    	videoSelector: '.js-video',
    	canvasSelector: g.canvas,
    	timelineSelector: '.video-timeline',
    	audio: true
    });

    // this is the context for canvas
    var canvas = g.canvas;
    var ctx = canvas.getContext('2d');
    // video dom
    var video = document.getElementById("video-1");

    var currentTime = $("input[placeholder=currentTime]");



    var action_rect = null;
    var edit_state = false

    g.bind("mousedown", (event) => {
        if ($(".js-rect").prop("checked") && action_rect == null && !edit_state) {

            $(".js-rect-editor").show();
            $(".js-hint").hide();

            //console.log(event);
            action_rect = g.createShape("rect", {
                style: {stroke:"#ccc", lineType:"dotted", lineWidth: 3},
                position: {x: event.position.x, y: event.position.y},
                width: 0,
                height: 0,
            })

            action_rect.resizing = true;

            g.children.add(action_rect); //temp rect

            action_rect.start_time = video.currentTime - 0.001 //for show at this time point
            action_rect.end_time = video.currentTime + 3

            //update input
            $("input[placeholder=top]").val(action_rect.position.y);
            $("input[placeholder=left]").val(action_rect.position.x);

            edit_state = true;
        }

        if ($(".js-arrawline").prop("checked")) {

        }

        return true;
    });

    g.bind("mousemove", (event) => {

        $(".js-mouse_top").val(event.position.y);
        $(".js-mouse_left").val(event.position.x);

        if ($(".js-rect").prop("checked") && action_rect !== null && edit_state) {

            if (event.event.buttons === 0)
                return ;

            if (!action_rect.resizing)
                return ;

            action_rect.width = event.position.x - action_rect.position.x;
            action_rect.height = event.position.y - action_rect.position.y;

            //update input
            $("input[placeholder=width]").val(action_rect.width);
            $("input[placeholder=height]").val(action_rect.height);

            return ;
        }


    });

    g.bind("mouseup", (event) => {

        if (action_rect === null) {
            return ;
        }

        if (action_rect.width < 2 && action_rect.height < 2) {
            exit_edit_state();
        }
        action_rect.style.stroke = "#F00";
        action_rect.canMove(true);
        action_rect.bind("moveend", function() {
            $("input[placeholder=top]").val(action_rect.position.y);
            $("input[placeholder=left]").val(action_rect.position.x);
        });
        action_rect.resizing = false;

        // var item = g.createShape("rect", {
        //     style: {stroke:"#F00",  lineWidth: 2},
        //     position: {x: action_rect.position.x, y: action_rect.position.y},
        //     width: action_rect.width,
        //     height: action_rect.height
        // });
        //
        // item.start_time = $("input[placeholder=start_time]").val() -0.01;
        // item.end_time = $("input[placeholder=end_time]").val(),
        //
        // g.children.add(item);
        // g.children.remove(action_rect);

        //action_rect = null;



    });

    // window.g = g;
    // window.arc = arc1;
    //requestAnimationFrame(update);
    //$(con).append($("#t-timeline").html());

    // var canvasVideo = new CanvasVideoPlayer({
    // 	videoSelector: '.js-video',
    // 	canvasSelector: '#video-container>canvas',
    // 	//timelineSelector: '#timeline',
    // 	audio: true
    // });

    window.update = function() {

        if (g.children) {
            g.children.each((i, item) => {
                item.visible = video.currentTime > item.start_time && video.currentTime < item.end_time;
            })
        }

        if (video.paused) {
            if (g.needUpdate) {
                g.redraw();
            }
        } else {
            currentTime.val(video.currentTime.toFixed(2));

            if (ctx) {
                ctx.drawImage(video, 0,0, canvas.width, canvas.height);

                if (g.children) {
                    g.children.each((i, item) => {
                        if (item.visible)
                            item.paint();
                    })
                }
            }
        }



        requestAnimationFrame(update);
    }

    update();

    const add_new_element = function() {
        let top         = Number.parseFloat($("input[placeholder=top]").val());
        let left        = Number.parseFloat($("input[placeholder=left]").val());
        let width       = Number.parseFloat($("input[placeholder=width]").val());
        let height      = Number.parseFloat($("input[placeholder=height]").val());
        let start_time  = video.currentTime - 0.01; //Number.parseFloat($("input[placeholder=start_time]").val());
        let end_time    = video.currentTime + Number.parseFloat($("input[placeholder=duration]").val());
        //let color       = $("input[placeholder=color]").val();

        // let rect = {
        //     style: {stroke: color,  lineWidth: 3, },
        //     position: {x: left, y: top},
        //     width: width,
        //     height: height
        // }

        action_rect.style.stroke = "#F00";
        action_rect.style.lineType = "solid";
        action_rect.position.x = left;
        action_rect.position.y = top;
        action_rect.width = width;
        action_rect.height = height;
        action_rect.start_time = start_time;
        action_rect.end_time = end_time;

        action_rect = null;
        edit_state = false;

        $(".js-rect-editor").hide();
        $(".js-hint").show();
    }

    const cancel_temp_element = function() {
        exit_edit_state();
    }

    const exit_edit_state = function() {
        if (!action_rect)
            return;

        action_rect.canMove(false);
        g.children.remove(action_rect);
        action_rect = null;
        edit_state = false;

        $(".js-rect-editor").hide();
        $(".js-hint").show();
    }

    $(function() {
        $(".js-current").change(function() {
            video.currentTime = Number.parseFloat($(this).val());
            currentTime.value = video.currentTime.toFixed(2);
        });

        video.ontimeupdate = () => {
             if (video.paused)
                 g.redraw();
        }

        // set fill the video under element
        g.style = {fillStyle: function () {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }};

        video.currentTime = 0.01;

        setTimeout(function() {
            g.redraw();
        }, 500);
    });

</script>
</body>
</html>
